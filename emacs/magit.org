#+title: Magit
#+property: header-args :results output silent :comments link :noweb yes

* Exec path from shell
#+begin_src emacs-lisp
  (use-package exec-path-from-shell
    :straight t
    :custom
    (exec-path-from-shell-variables '("PATH"
                                      "MANPATH"
                                      "NIX_PATH"
                                      "NIX_SSL_CERT_FILE"))
    :hook (after-init . exec-path-from-shell-initialize))
#+end_src

* Magit
#+begin_src emacs-lisp
  (use-package magit
    :straight t
    :after exec-path-from-shell
    :bind
    ("C-c g" . magit-status)
    ("C-x g" . magit-status)
    ("C-x G" . magit-list-repositories)
    :custom
    (magit-diff-refine-hunk 'all)
    (magit-save-repository-buffers 'dontask)
    (magit-section-initial-visibility-alist
     '((untracked . show)
       (unstaged  . show)
       (unpushed  . show)
       (upstream  . show)))
    ;;(magit-auto-revert-mode t)
    (magit-push-always-verify nil)
    (magit-repository-directories '(("~/org"     . 0)
                                    ("~/.config" . 0)))
    (magit-no-confirm '(stage-all-changes
                        unstage-all-changes))
    :config
    <<magit-status>>
    <<magit-quit-session>>)
#+end_src

#+name: magit-status
#+begin_src emacs-lisp
  (defadvice magit-status (around magit-fullscreen activate)
       (window-configuration-to-register :magit-fullscreen)
       ad-do-it
       (delete-other-windows))
#+end_src

#+name: magit-quit-session
#+begin_src emacs-lisp
(defun magit-quit-session ()
      "Restores the previous window configuration and kills the magit buffer"
      (interactive)
      (kill-buffer)
      (auto-revert-mode -1)
      (jump-to-register :magit-fullscreen))
#+end_src
